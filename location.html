<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Location — Consent-based Tracker</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2Xmk5bKQK6vYH+0wJxgNq2f4hWvZgF7v6o5m0m0=" crossorigin=""/>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,'Helvetica Neue',Arial;color:#e6eef8;background:linear-gradient(180deg,#071024 0%, #07192b 100%);min-height:100vh}
    .app{max-width:1024px;margin:32px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px}
    header h1{margin:0;font-size:20px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 30px rgba(2,6,23,0.6);}
    .controls{display:flex;gap:10px;align-items:center}
    button{background:var(--accent);border:0;color:#021025;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    #map{height:520px;border-radius:10px;margin-top:12px}
    .right{display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:12px}
    label{font-size:13px;color:var(--muted)}
    input[type=text]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
    .peeps{max-height:200px;overflow:auto}
    .peep{display:flex;justify-content:space-between;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
    .small{font-size:12px;color:var(--muted)}
    footer{margin-top:18px;font-size:12px;color:var(--muted)}
    @media(max-width:900px){.row{flex-direction:column}.right{order:2}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div style="width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#06b6d4,#3b82f6);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021025">LL</div>
      <div>
        <h1>Live Location — Consent-based</h1>
        <div class="small">Simple demo: users share location; map shows live positions. Requires Firebase config (see instructions).</div>
      </div>
    </header><div class="row" style="margin-top:16px;gap:16px">
  <div style="flex:1" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <label>Name</label>
        <div><input id="name" type="text" placeholder="Your name (e.g. Mina)" /></div>
      </div>
      <div class="controls">
        <button id="startBtn">Start sharing</button>
        <button id="stopBtn" class="ghost" disabled>Stop</button>
      </div>
    </div>

    <div id="status" style="margin-top:12px" class="small">Status: not sharing</div>

    <div id="map" style="margin-top:12px"></div>

  </div>

  <div style="width:300px" class="right">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><strong>Active sharers</strong></div>
        <div class="small">Realtime</div>
      </div>
      <div class="peeps" id="peeps"></div>
    </div>

    <div class="card small">
      <div><strong>Setup</strong></div>
      <ol>
        <li>Create Firebase project & Firestore (or Realtime DB). Enable Anonymous Auth (optional).</li>
        <li>Replace <code>FIREBASE_CONFIG</code> in the script below with your project's config.</li>
        <li>Deploy: push this <em>index.html</em> to a GitHub repo and enable Pages (branch main / docs/).</li>
      </ol>
    </div>

  </div>
</div>

<footer class="small">Note: Browser requires the page to be open (foreground) for continuous updates. For genuine background tracking build a native app.</footer>

  </div>  <!-- Leaflet JS -->  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-kxA+g1k9e+S1K1w7g9ZQjF2m2Y2kFj8Fj3xD3yY0F8M=" crossorigin=""></script>  <!-- Firebase v9 (modular) CDN -->  <script type="module">
    // ====== CONFIGURE THIS ======
    // Replace the object below with your Firebase project's config.
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyD4O6SHrpeDnzKMBWkudVFk1j1JoYiO3HY",
      authDomain: "calling-app-e7ad2.firebaseapp.com",
      projectId: "calling-app-e7ad2",
      storageBucket: "calling-app-e7ad2.firebasestorage.app",
      messagingSenderId: "241816266208",
      appId: "1:241816266208:web:16f60c06feb8919da83785"
    };
    // ===========================

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

    const app = initializeApp(FIREBASE_CONFIG);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Anonymous sign-in (makes security rules easier)
    signInAnonymously(auth).catch((e)=>console.error('Auth error',e));

    let userId = null;
    onAuthStateChanged(auth, (u)=>{
      if(u) userId = u.uid;
    });

    // UI elements
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const nameEl = document.getElementById('name');
    const peepsEl = document.getElementById('peeps');

    // Map init
    const map = L.map('map', {zoomControl:true}).setView([23.8103,90.4125], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);

    const markers = new Map(); // uid -> marker

    // Listen for realtime updates from Firestore collection 'live_locations'
    const colRef = collection(db, 'live_locations');
    onSnapshot(colRef, (snap)=>{
      peepsEl.innerHTML = '';
      const seen = new Set();
      snap.forEach(docSnap=>{
        const data = docSnap.data();
        const id = docSnap.id;
        seen.add(id);
        // update list
        const div = document.createElement('div'); div.className='peep';
        const left = document.createElement('div'); left.innerHTML = <div style="font-weight:700">${escapeHtml(data.name||'Anonymous')}</div><div class="small">${new Date((data.ts && data.ts.toMillis && data.ts.toMillis())||data.ts).toLocaleString()}</div>;
        const right = document.createElement('div'); right.innerHTML = <div class="small">${(data.lat||'')}, ${(data.lon||'')}</div>;
        div.appendChild(left); div.appendChild(right);
        peepsEl.appendChild(div);

        // map marker
        const lat = data.lat; const lon = data.lon;
        if(lat && lon){
          const key = id;
          if(markers.has(key)){
            markers.get(key).setLatLng([lat,lon]);
          } else {
            const m = L.marker([lat,lon]);
            m.bindPopup(<strong>${escapeHtml(data.name||'Anonymous')}</strong><br/>${lat.toFixed(5)}, ${lon.toFixed(5)});
            m.addTo(map);
            markers.set(key,m);
          }
        }
      });
      // remove markers for stale docs
      for(const k of Array.from(markers.keys())){
        if(!seen.has(k)){
          map.removeLayer(markers.get(k));
          markers.delete(k);
        }
      }
    });

    // Utility: escape HTML
    function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // Sharing control
    let watchId = null;
    let userDocRef = null;

    startBtn.addEventListener('click', async ()=>{
      const displayName = nameEl.value.trim() || 'Anonymous';
      if(!userId){
        statusEl.innerText = 'Waiting for auth...';
        return;
      }
      userDocRef = doc(db, 'live_locations', userId);

      // request permission + start watch
      if(!navigator.geolocation){ statusEl.innerText = 'Geolocation not supported'; return; }

      startBtn.disabled = true; stopBtn.disabled = false;
      statusEl.innerText = 'Requesting location permission...';

      watchId = navigator.geolocation.watchPosition(async (pos) => {
        const payload = {
          name: displayName,
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          accuracy: pos.coords.accuracy,
          ts: serverTimestamp()
        };
        try{
          await setDoc(userDocRef, payload, {merge:true});
          statusEl.innerText = Sharing: ${payload.lat.toFixed(5)}, ${payload.lon.toFixed(5)} (acc ${payload.accuracy}m);
        }catch(e){ console.error(e); statusEl.innerText = 'Write error: '+e.message; }
      }, (err)=>{
        console.error('geo error',err);
        statusEl.innerText = 'Permission denied or error: '+err.message;
        startBtn.disabled = false; stopBtn.disabled = true;
        if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId = null; }
      }, {enableHighAccuracy:true, maximumAge:3000, timeout:10000});
    });

    stopBtn.addEventListener('click', async ()=>{
      if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      if(userDocRef){ try{ await deleteDoc(userDocRef); }catch(e){} }
      statusEl.innerText = 'Stopped sharing.';
      startBtn.disabled = false; stopBtn.disabled = true;
    });

    // Cleanup on unload: remove user's doc so they don't appear after leaving
    window.addEventListener('beforeunload', async ()=>{
      try{ if(userDocRef) await deleteDoc(userDocRef); }catch(e){}
    });

  </script></body>
</html>
